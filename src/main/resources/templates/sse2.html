<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SseEmitter</title>
</head>
<body>
<label for="clientId">clientId</label><input type="text" id="clientId" />输入clientId<br/>
<button onclick="openSse()">开启连接</button>
<button onclick="closeSse()">关闭连接</button>
<div id="message"></div>
</body>
<script src="/eventsource.min.js"></script>
<script>
    // 监听窗口关闭事件，主动去关闭sse连接，如果服务端设置永不过期，浏览器关闭后手动清理服务端数据
    window.onbeforeunload = function () {
        closeSse();
    };
    let source = null;
    function openSse() {
        // 用时间戳模拟登录用户
        const userId = new Date().getTime();
        if (!!window.EventSource) {
            // 建立连接
            let elementById = document.getElementById("clientId");
            source = new EventSourcePolyfill('http://localhost:8080/sse/CreateSseConnect?clientId='+elementById.value, {
                headers: {
                    'X-Access-Token': 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0ZW5hbnRJZCI6MywiZXhwIjoxNjUwODkwNzM4LCJ1c2VybmFtZSI6ImFkbWluIn0.u0pyEicQLBgnM7DLwozhBSAGRprMIGgpbFf_mfCw6_s'
                }
            });
            /**
             * 连接一旦建立，就会触发open事件
             * 另一种写法：source.onopen = function (event) {}
             */
            source.addEventListener('open', function (e) {
                setMessageInnerHTML("建立连接。。。");
            }, false);
            /**
             * 客户端收到服务器发来的数据
             * 另一种写法：source.onmessage = function (event) {}
             */
            source.addEventListener('message', function (e) {
                setMessageInnerHTML(e.data);
            });
            /**
             * 如果发生通信错误（比如连接中断），就会触发error事件
             * 或者：
             * 另一种写法：source.onerror = function (event) {}
             */
            source.addEventListener('error', function (e) {
                if (e.readyState === EventSource.CLOSED) {
                    setMessageInnerHTML("连接关闭");
                } else {
                    console.log(e);
                }
            }, false);
        } else {
            setMessageInnerHTML("你的浏览器不支持SSE");
        }
    }
    // 关闭Sse连接
    function closeSse() {
        source.close();
        let elementById = document.getElementById("clientId");
        const httpRequest = new XMLHttpRequest();
        httpRequest.open('GET', 'http://localhost:8080/sse/CloseSseConnect?clientId=' + elementById.value, true);
        httpRequest.send();
        console.log("close");
    }
    // 将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {
        document.getElementById('message').innerHTML += innerHTML + '<br/>';
    }
</script>
</html>
